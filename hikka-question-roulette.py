# meta developer: @your_nickname
# meta pic: none
# meta banner: https://example.com/banner.png

from .. import loader, utils
from telethon.tl.types import Message
from telethon.tl.custom import Button
import logging
import random
import asyncio

logger = logging.getLogger(__name__)

@loader.tds
class RandomQuestionGameMod(loader.Module):
    """üéÆ –ò–≥—Ä–∞ –≤ –≤–æ–ø—Ä–æ—Å—ã —Å 6 —Ä–µ–∂–∏–º–∞–º–∏ –∏ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞"""

    strings = {
        "name": "RandomQuestionGame",
        "menu": (
            "<b>üé≤ Random Question Game</b>\n\n"
            "<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∂–∏–º—ã:</b>\n"
            "1Ô∏è‚É£ <b>–û–±—ã—á–Ω—ã–µ</b> ‚Äî –≤–æ–ø—Ä–æ—Å—ã –æ–±–æ –≤—Å—ë–º (—Ö–æ–±–±–∏, –µ–¥–∞, –º–µ—á—Ç—ã)\n"
            "2Ô∏è‚É£ <b>–õ–∏—á–Ω—ã–µ</b> ‚Äî —Å–µ–∫—Ä–µ—Ç—ã, —Å—Ç—Ä–∞—Ö–∏, —Å–æ–∂–∞–ª–µ–Ω–∏—è\n"
            "3Ô∏è‚É£ <b>–ü—Ä–æ—Ç–∏–≤</b> ‚Äî –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞–ø—Ä–æ—Ç–∏–≤ (–∫—Ç–æ —á–∞—â–µ...)\n"
            "4Ô∏è‚É£ <b>–ü–∏–∫–∞–Ω—Ç–Ω—ã–µ</b> ‚Äî 18+/—Ñ–ª–∏—Ä—Ç (–ø–æ—Ü–µ–ª—É–∏, —Ç–∏–ø–∞–∂–∏, —Å–≤–∏–¥–∞–Ω–∏—è)\n"
            "5Ô∏è‚É£ <b>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ</b> ‚Äî –ø—Ä–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —ç–º–æ—Ü–∏–∏, —Å—Ç—Ä–µ—Å—Å\n"
            "6Ô∏è‚É£ <b>–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ</b> ‚Äî –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Å–æ—Ü—Å–µ—Ç–µ–π (—Å–µ–ª—Ñ–∏, —Å–æ–æ–±—â–µ–Ω–∏—è)\n\n"
            "<b>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</b>\n"
            "1. –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å —Ä–µ–∂–∏–º–æ–º\n"
            "2. –í—Å–µ –∂–µ–ª–∞—é—â–∏–µ –∂–º—É—Ç ‚úÖ –Ω–∞ –º–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
            "3. –ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ —è –≤—ã–¥–∞–º –≤–æ–ø—Ä–æ—Å"
        ),
        "waiting": "<b>üéØ –ò–≥—Ä–æ–∫–∏, –∂–º–∏—Ç–µ ‚úÖ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥!</b>\n–†–µ–∂–∏–º: {}",
        "timeout": "<b>‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ. –ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.</b>",
        "question": "<b>‚ùì –í–æ–ø—Ä–æ—Å:</b>\n<code>{}</code>",
        "players": "<b>üéÆ –ò–≥—Ä–æ–∫–∏:</b> {}",
    }

    def __init__(self):
        self.questions = {
            "–æ–±—ã—á–Ω—ã–µ": [
                "–ö–∞–∫–æ–µ —Ç–≤–æ—ë –ª—é–±–∏–º–æ–µ –±–ª—é–¥–æ?",
                "–ß—Ç–æ —Ç—ã –±—É–¥–µ—à—å –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –≤—ã–∏–≥—Ä–∞–µ—à—å –º–∏–ª–ª–∏–æ–Ω?",
                "–ö–∞–∫–æ–π —Ç–≤–æ–π —Å–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π —Å—Ç—Ä–∞—Ö?",
                "–ö–∞–∫–∞—è –º—É–∑—ã–∫–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ç–µ–±–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
                "–ì–¥–µ —Ç—ã –º–µ—á—Ç–∞–µ—à—å –ø–æ–±—ã–≤–∞—Ç—å?",
                "–ß—Ç–æ —Ç—ã —Ü–µ–Ω–∏—à—å –≤ –¥—Ä—É–∑—å—è—Ö –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?",
                "–ö–∞–∫–æ–π —Ç–≤–æ–π –ª—é–±–∏–º—ã–π —Ñ–∏–ª—å–º?",
                "–ö–∞–∫–æ–µ —Ö–æ–±–±–∏ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?",
                "–ß—Ç–æ —Ç–µ–±—è –±–µ—Å–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?",
                "–¢—ã –∂–∞–≤–æ—Ä–æ–Ω–æ–∫ –∏–ª–∏ —Å–æ–≤–∞?"
            ],
            "–ª–∏—á–Ω—ã–µ": [
                "–ß—Ç–æ —Ç–µ–±—è –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–∫–∞—Ç—å?",
                "–ö–æ–º—É —Ç—ã –¥–æ–≤–µ—Ä—è–µ—à—å –±–æ–ª—å—à–µ –≤—Å–µ—Ö?",
                "–ö–∞–∫–æ–π —É —Ç–µ–±—è —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Å–µ–∫—Ä–µ—Ç?",
                "–ß–µ–≥–æ —Ç—ã —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è –≤ —Å–µ–±–µ?",
                "–û —á—ë–º —Ç—ã –∂–∞–ª–µ–µ—à—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?",
                "–ö–æ–≥–æ –∏–∑ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç—ã –∑–Ω–∞–µ—à—å –¥–æ–ª—å—à–µ –≤—Å–µ—Ö?",
                "–ß—Ç–æ –±—ã —Ç—ã –∏–∑–º–µ–Ω–∏–ª –≤ —Å–≤–æ—ë–º –ø—Ä–æ—à–ª–æ–º?",
                "–¢—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –≤—Ä–∞–ª –ª—É—á—à–µ–º—É –¥—Ä—É–≥—É?",
                "–ß–µ–≥–æ —Ç—ã –±–æ–∏—à—å—Å—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
                "–ß—Ç–æ —Ç–µ–±—è –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ —É—Ç—Ä–∞–º?"
            ],
            "–ø—Ä–æ—Ç–∏–≤": [
                "–ö—Ç–æ –∏–∑ –Ω–∞—Å —á–∞—â–µ –≤—Ä—ë—Ç?",
                "–ö—Ç–æ –±–æ–ª—å—à–µ —Ä–∏—Å–∫—É–µ—Ç –≤ –∂–∏–∑–Ω–∏?",
                "–ö—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞–π–¥—ë—Ç –ø–∞—Ä—É?",
                "–ö—Ç–æ —á–∞—â–µ –æ–ø–∞–∑–¥—ã–≤–∞–µ—Ç?",
                "–ö—Ç–æ –ª—É—á—à–µ –≥–æ—Ç–æ–≤–∏—Ç?",
                "–ö—Ç–æ –±–æ–ª—å—à–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç?",
                "–ö—Ç–æ –±–æ–ª–µ–µ –ª–µ–Ω–∏–≤—ã–π?",
                "–ö—Ç–æ —á–∞—â–µ —Å–∏–¥–∏—Ç –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ?",
                "–ö—Ç–æ –ª—É—á—à–µ —Ç–∞–Ω—Ü—É–µ—Ç?",
                "–ö—Ç–æ –≥—Ä–æ–º—á–µ —Å–º–µ—ë—Ç—Å—è?"
            ],
            "–ø–∏–∫–∞–Ω—Ç–Ω—ã–µ": [
                "–° –∫–µ–º –∏–∑ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç—ã –±—ã –ø–æ—Ü–µ–ª–æ–≤–∞–ª—Å—è?",
                "–ö–∞–∫–æ–π —Ç–∏–ø–∞–∂ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ –ø–æ–ª–∞ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?",
                "–ë—ã–ª –ª–∏ —É —Ç–µ–±—è –æ–ø—ã—Ç –Ω–∞ –æ–¥–Ω—É –Ω–æ—á—å?",
                "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∏–∑–º–µ–Ω–∞?",
                "–°–∞–º–æ–µ —Å–º–µ—à–Ω–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏?",
                "–¢—ã –ª—é–±–∏—à—å —Ñ–ª–∏—Ä—Ç–æ–≤–∞—Ç—å?",
                "–ö–∞–∫–∞—è —á–∞—Å—Ç—å —Ç–µ–ª–∞ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –≤ –ª—é–¥—è—Ö?",
                "–ß—Ç–æ –±—ã —Ç—ã —Å–¥–µ–ª–∞–ª, –µ—Å–ª–∏ –±—ã –æ—Å—Ç–∞–ª—Å—è –Ω–∞–µ–¥–∏–Ω–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?",
                "–¢—ã –≤–µ—Ä–∏—à—å –≤ –ª—é–±–æ–≤—å —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞?",
                "–ö–∞–∫–æ–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç —Ç–µ–±–µ –∑–∞–ø–æ–º–Ω–∏–ª—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?"
            ],
            "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ": [
                "–¢—ã —á–∞—â–µ —Å–ª—É—à–∞–µ—à—å —Ä–∞–∑—É–º –∏–ª–∏ —Å–µ—Ä–¥—Ü–µ?",
                "–ß—Ç–æ –≤—ã–±–µ—Å–∏—Ç —Ç–µ–±—è –∑–∞ —Å–µ–∫—É–Ω–¥—É?",
                "–¢—ã –∑–ª–æ–ø–∞–º—è—Ç–Ω—ã–π?",
                "–ö–∞–∫ —Ç—ã —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º?",
                "–¢—ã –¥–æ–≤–µ—Ä—è–µ—à—å –ª—é–¥—è–º –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å?",
                "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∏–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö?",
                "–¢—ã –±–æ–ª—å—à–µ –∏–Ω—Ç—Ä–æ–≤–µ—Ä—Ç –∏–ª–∏ —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç?",
                "–ö–∞–∫ —Ç—ã –º–∏—Ä–∏—à—å—Å—è –ø–æ—Å–ª–µ —Å—Å–æ—Ä—ã?",
                "–¢—ã —á–∞—â–µ –∂–∞–ª–µ–µ—à—å –æ —Ç–æ–º, —á—Ç–æ —Å–¥–µ–ª–∞–ª –∏–ª–∏ –Ω–µ —Å–¥–µ–ª–∞–ª?",
                "–ß—Ç–æ —Ç–µ–±—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç?"
            ],
            "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ": [
                "–û—Ç–ø—Ä–∞–≤—å —Å–ª—É—á–∞–π–Ω–æ–µ —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –≤ —á–∞—Ç",
                "–ù–∞–ø–∏—à–∏ '–ü—Ä–∏–≤–µ—Ç' –ª—é–±–æ–º—É –∫–æ–Ω—Ç–∞–∫—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞",
                "–ü–æ—Å—Ç–∞–≤—å –ª–∞–π–∫ –Ω–∞ —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –ø–æ—Å—Ç —É –¥—Ä—É–≥–∞",
                "–û—Ç–ø—Ä–∞–≤—å —Å–º–µ—à–Ω–æ–π –º–µ–º –≤ —á–∞—Ç",
                "–ù–∞–ø–∏—à–∏ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç —Å–æ—Å–µ–¥—É —Å–ø—Ä–∞–≤–∞",
                "–°–¥–µ–ª–∞–π —Å–µ–ª—Ñ–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å —Å—é–¥–∞",
                "–ù–∞–ø–∏—à–∏ —Ä–∞–Ω–¥–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–∞–º–µ",
                "–ü–æ—Å—Ç–∞–≤—å —Å—Ç–∞—Ç—É—Å '–Ø –≤ –∏–≥—Ä–µ' –Ω–∞ 10 –º–∏–Ω—É—Ç",
                "–û—Ç–ø—Ä–∞–≤—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å –ø–µ–Ω–∏–µ–º –ª—é–±–∏–º–æ–π –ø–µ—Å–Ω–∏",
                "–ù–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ —Å–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ñ–∞–∫—Ç –∏ —Å–∫–∏–Ω—å"
            ]
        }
        
        self.mode_names = {
            "–æ–±—ã—á–Ω—ã–µ": "1Ô∏è‚É£ –û–±—ã—á–Ω—ã–µ",
            "–ª–∏—á–Ω—ã–µ": "2Ô∏è‚É£ –õ–∏—á–Ω—ã–µ",
            "–ø—Ä–æ—Ç–∏–≤": "3Ô∏è‚É£ –ü—Ä–æ—Ç–∏–≤",
            "–ø–∏–∫–∞–Ω—Ç–Ω—ã–µ": "4Ô∏è‚É£ –ü–∏–∫–∞–Ω—Ç–Ω—ã–µ",
            "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ": "5Ô∏è‚É£ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ",
            "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ": "6Ô∏è‚É£ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ"
        }

    @loader.command()
    async def gamecmd(self, message: Message):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –∏–≥—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏"""
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        buttons = [
            [
                Button.inline("1Ô∏è‚É£ –û–±—ã—á–Ω—ã–µ", data="mode_–æ–±—ã—á–Ω—ã–µ"),
                Button.inline("2Ô∏è‚É£ –õ–∏—á–Ω—ã–µ", data="mode_–ª–∏—á–Ω—ã–µ"),
                Button.inline("3Ô∏è‚É£ –ü—Ä–æ—Ç–∏–≤", data="mode_–ø—Ä–æ—Ç–∏–≤"),
            ],
            [
                Button.inline("4Ô∏è‚É£ –ü–∏–∫–∞–Ω—Ç–Ω—ã–µ", data="mode_–ø–∏–∫–∞–Ω—Ç–Ω—ã–µ"),
                Button.inline("5Ô∏è‚É£ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ", data="mode_–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ"),
                Button.inline("6Ô∏è‚É£ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ", data="mode_—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ"),
            ],
            [
                Button.inline("‚ùì –ü–æ–º–æ—â—å", data="help"),
            ]
        ]
        
        await utils.answer(message, self.strings("menu"), buttons=buttons)

    async def game_handler(self, mode: str, call):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–≥—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞"""
        mode_display = self.mode_names.get(mode, mode)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –∏–≥—Ä–æ–∫–æ–≤
        msg = await call.edit(
            self.strings("waiting").format(mode_display),
            buttons=[[Button.inline("‚ùå –û—Ç–º–µ–Ω–∞", data="cancel")]]
        )
        
        try:
            # –ñ–¥—ë–º 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤
            await asyncio.sleep(30)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏
            players = []
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ç–æ –Ω–∞–∂–∞–ª ‚úÖ
            async for user in msg.client.iter_participants(msg.chat_id):
                # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π
                # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                players.append(user.first_name or f"User{user.id}")
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞
            players = players[:5]
            
            if len(players) < 2:
                await call.edit(self.strings("timeout"))
                return
                
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å
            question = random.choice(self.questions[mode])
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            players_text = ", ".join(players)
            response = self.strings("players").format(players_text) + "\n\n" + self.strings("question").format(question)
            
            await call.edit(response)
            
        except Exception as e:
            logger.error(f"Game error: {e}")
            await call.edit(f"<b>‚ùå –û—à–∏–±–∫–∞:</b> {str(e)}")

    @loader.callback_handler()
    async def callback_handler(self, call):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–æ–∫"""
        data = call.data.decode()
        
        if data == "help":
            await call.answer("‚ùì –í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –∏ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É", alert=True)
            return
            
        if data == "cancel":
            await call.edit("‚ùå –ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞")
            return
            
        if data.startswith("mode_"):
            mode = data[5:]  # —É–±–∏—Ä–∞–µ–º "mode_"
            await self.game_handler(mode, call)
            return
